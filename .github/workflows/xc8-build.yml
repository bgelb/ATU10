name: XC8 Firmware Build

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, ci-xc8 ]

jobs:
  build:
    # Use a prebuilt XC8 container hosted on GHCR (public).
    container:
      image: ghcr.io/koendv/xc8:3.00
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          apt-get update
          apt-get install -y --no-install-recommends curl unzip ca-certificates

      - name: Fetch PIC16F1xxxx device pack
        run: |
          mkdir -p /root/.mchp_packs/Microchip/PIC16F1xxxx_DFP/1.28.431
          curl -L -o /tmp/PIC16F1xxxx_DFP.atpack https://packs.download.microchip.com/Microchip.PIC16F1xxxx_DFP.1.28.431.atpack
          unzip -q /tmp/PIC16F1xxxx_DFP.atpack -d /root/.mchp_packs/Microchip/PIC16F1xxxx_DFP/1.28.431

      - name: Build firmware 1.6 with XC8
        working-directory: Firmware/ATU-10_FW_16
        env:
          XC8: /opt/microchip/xc8/v3.00/bin/xc8-cc
          MDFP: /root/.mchp_packs/Microchip/PIC16F1xxxx_DFP/1.28.431/xc8
        run: |
          make
