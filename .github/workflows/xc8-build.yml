name: XC8 Firmware Build

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, ci-xc8 ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends curl unzip ca-certificates

      - name: Setup XC8
        id: setup-xc8
        uses: usimd/setup-xc-action@v1
        with:
          compiler: xc8
          version: 3.10

      - name: Fetch PIC16F1xxxx device pack
        run: |
          mkdir -p /home/runner/.mchp_packs/Microchip/PIC16F1xxxx_DFP/1.28.431
          curl -L -o /tmp/PIC16F1xxxx_DFP.atpack https://packs.download.microchip.com/Microchip.PIC16F1xxxx_DFP.1.28.431.atpack
          unzip -q /tmp/PIC16F1xxxx_DFP.atpack -d /home/runner/.mchp_packs/Microchip/PIC16F1xxxx_DFP/1.28.431

      - name: Build firmware 1.6 with XC8
        working-directory: Firmware/ATU-10_FW_16
        env:
          XC8: ${{ steps.setup-xc8.outputs.compiler-path }}
          MDFP: /home/runner/.mchp_packs/Microchip/PIC16F1xxxx_DFP/1.28.431/xc8
        run: |
          make
